<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../img/logos/logo 1.jpeg" type="image/x-icon">
    <title>Editar Productos</title>
    <link rel="stylesheet" href="../log/admin.css">
   
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <img src="../img/logos/logo_1-removebg-sin fondo.png" alt="Logo" class="img-fluid">
        </a>
        <nav>
            <a href="../index.html">Inicio</a>
            <a href="../PRODUCTO/productos.html">Productos</a>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="admin-section">
                <h2>Administrar Productos</h2>
                <form id="product-form" class="product-form" action="../conexion.php" method="POST"
                    enctype="multipart/form-data">
                    <ul class="form-list">
                        <li style="position: relative;">
                            <label for="product-name">Nombre del Producto:</label>
                            <input type="text" id="product-name" name="product-name" placeholder="Nombre del producto" required>
                            <!-- Contenedor para los resultados de autocompletado, ahora debajo del campo de texto -->
                            <div id="autocomplete-results"></div>
                            <!-- Campos ocultos para almacenar idarticulo y codarticulo -->
                            <input type="hidden" id="product-id" name="product-id">
                            <input type="hidden" id="product-code" name="product-code">
                        </li>
                        
                        <li>
                            <label for="product-description">Descripción:</label>
                            <textarea id="product-description" name="product-description" rows="4"
                                placeholder="Descripción del producto"></textarea>
                        </li>
                        <li>
                            <label for="product-price">Precio:</label>
                            <input type="number" id="product-price" name="product-price"
                                placeholder="Precio del producto" step="0.01" required>
                        </li>
                        <li>
                            <label for="product-image">Imagen:</label>
                            <input type="file" id="product-image" name="product-image" accept="image/*">
                            <!-- Contenedor para la vista previa de la imagen -->
                            <div id="image-preview-container" style="display: none;">
                                <h3>Vista previa de la Imagen:</h3>
                                <img id="image-preview" src="" alt="Vista previa de la imagen"
                                    style="max-width: 200px;">
                            </div>
                        </li>
                        <li>
                            <label for="show-on-homepage">Mostrar en Inicio:</label>
                            <input type="checkbox" id="show-on-homepage" name="show-on-homepage">
                        </li>
                        <div id="group-box"
                            style="display:none; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 5px; padding: 15px; margin-top: 15px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);">
                            <h3 style="font-size: 18px; margin-bottom: 10px;">Opciones para mostrar en inicio</h3>
                            <label for="inicioOptions" style="display: block; margin-bottom: 5px;">Seleccione una
                                opción:</label>
                            <select id="inicioOptions" name="inicioOptions"
                                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 16px;">
                                <option value="1">Productos Nuevos</option>
                                <option value="2">Productos Destacados</option>
                                <option value="3">Productos más queridos</option>
                            </select>
                        </div>
                    </ul>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button id="add-product-button" type="button">Guardar Producto</button>
                        <!-- Añadir el label para mostrar el ID -->
                        <label id="product-id-label" style="font-weight: bold; display: none;">-</label>
                    </div>
                </form>
            </div>
        </div>


        <div id="group-box">
            <h3 style="font-size: 18px; margin-bottom: 10px;">Opción de Búsqueda</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="article-search" class="form-label">Búsqueda de Artículo:</label>
                    <input type="text" id="article-search" name="article-search" class="form-control"
                        placeholder="Buscar artículo">
                </div>

                <div class="col-md-6">
                    <label for="status-filter" class="form-label">Seleccione una opción:</label>
                    <select id="status-filter" name="status-filter" class="form-control">
                        <option value="ACT">ACTIVOS</option>
                        <option value="ANU">ANULADOS</option>
                    </select>
                </div>
            </div>

            <!-- New section for pagination controls -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <!-- Label to show current page range -->
                    <div id="page-info" class="mb-3" data-page-index="1">
                        <span id="firstrow-label">Mostrando <span id="firstrow">1</span> a <span id="lastrow">10</span>
                            de <span id="totalrows">100</span> resultados</span>
                    </div>
                    <!-- Button to go to the next page -->
                    <button id="next-page" class="btn btn-primary">Siguiente Página</button>
                </div>
            </div>

            <!-- Container to display search results -->
            <div id="results-container">
                <!-- Results will be dynamically inserted here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initial data fetch
            fetchArticles('', 'ACT', 1);
        });

        document.getElementById('show-on-homepage').addEventListener('change', function () {
            const groupBox = document.getElementById('group-box');
            groupBox.style.display = this.checked ? 'block' : 'none';
        });

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        document.getElementById('product-name').addEventListener('input', debounce(function () {
    const query = this.value;
    const resultsContainer = document.getElementById('autocomplete-results');
    const inputRect = this.getBoundingClientRect();
    const containerRect = this.parentNode.getBoundingClientRect(); // Obtener el contenedor `li`

    if (query.length > 2) {
        fetch(`../php/search.php?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(product => {
                        const resultItem = document.createElement('div');
                        resultItem.textContent = `${product.articulo} (Código: ${product.codarticulo})`;
                        resultItem.addEventListener('click', function () {
                            document.getElementById('product-name').value = product.articulo;
                            document.getElementById('product-id').value = product.idarticulo;
                            document.getElementById('product-code').value = product.codarticulo;
                            resultsContainer.style.display = 'none';
                        });
                        resultsContainer.appendChild(resultItem);
                    });

                    resultsContainer.style.display = 'block';
                    // Ajustar la posición del contenedor para que esté justo debajo del campo de texto con un pequeño margen
                    resultsContainer.style.top = `${inputRect.height + 30}px`; // Ajusta el margen según sea necesario
                    resultsContainer.style.left = '0'; // Alineado con el campo de texto
                    resultsContainer.style.width = `${inputRect.width}px`; // Ancho igual al campo de texto
                } else {
                    resultsContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al buscar el producto. Verifica la Consola del Navegador para más detalles.');
            });
    } else {
        resultsContainer.style.display = 'none';
    }
}, 300));


        document.getElementById('product-form').addEventListener('submit', function (event) {
            event.preventDefault();

            // Establecer el tipo basado en si es una modificación
            const tipo = document.getElementById('product-id').value ? 'MOD' : 'NEW';
            document.getElementById('product-type').value = tipo;

            const formData = new FormData(this);

            fetch('../conexion.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Producto guardado exitosamente.');
                        document.getElementById('product-form').reset();
                        document.getElementById('autocomplete-results').innerHTML = '';
                        document.getElementById('group-box').style.display = 'none';
                    } else {
                        alert('Error al guardar el producto. Verifica la Consola del Navegador para más detalles.');
                        console.error('Error al guardar el producto:', data.message);
                    }
                })
                .catch(error => {
                    alert('Error al guardar el producto. Verifica la Consola del Navegador para más detalles.');
                    console.error('Error:', error);
                });
        });

        function fetchArticles(query, status, pageIndex) {
            fetch(`../php/serch_articulos.php?textosearch=${encodeURIComponent(query)}&estatus=${encodeURIComponent(status)}&pageIndex=${pageIndex}&pageSize=10`)
                .then(response => response.json())
                .then(data => {
                    displayResults(data.results);
                    updatePagination(data.totalrows, data.firstrow, data.lastrow);
                })
                .catch(error => {
                    console.error('Error fetching articles:', error);
                });
        }

        // Función para mostrar la vista previa de la imagen cuando se hace clic en el botón de edición
        function showEditImage(imageUrl) {
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            // Configura la fuente de la imagen de vista previa
            previewImage.src = imageUrl;

            // Muestra el contenedor de vista previa
            previewContainer.style.display = 'block';
        }

        // Función para manejar los resultados de búsqueda y mostrar productos
        function displayResults(results) {
            console.log(results); // Verifica los datos recibidos
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';

            results.forEach(result => {
                console.log(result); // Verifica cada objeto result

                // Usa el campo urlimagen si está disponible, de lo contrario, usa una imagen predeterminada
                const imageUrl = result.urlimagen ? `../uploads/${result.urlimagen}` : '../uploads/default-image.png';

                const resultDiv = document.createElement('div');
                resultDiv.classList.add('result-item');

                resultDiv.innerHTML = `
        <div style="display: flex; align-items: center;">
            <img src="${imageUrl}" alt="${result.desc_articulo || 'Imagen'}" style="max-width: 100px; margin-right: 10px;">
            <div>
                <h4>${result.articulo}</h4>
                <p>Descripción: ${result.desc_articulo}</p>
                <p>Precio: ${result.precio}</p>
                <button class="edit-button" data-id="${result.id}" data-id-subartic="${result.idsubartic}" data-image-url="${imageUrl}">
                    <img src="../img/iconos/editar.png" alt="Editar" style="width: 20px; height: 20px;">
                </button>
            </div>
        </div>
        `;
                resultsContainer.appendChild(resultDiv);
            });

            // Agrega un manejador de eventos para los botones de edición
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    const idSubartic = this.getAttribute('data-id-subartic');
                    const imageUrl = this.getAttribute('data-image-url');
                    loadProductData(id, idSubartic);
                    showEditImage(imageUrl); // Muestra la imagen editada

                    // Guardar el tipo como 'MOD'
                    tipo = 'MOD';
                    console.log('Tipo:', tipo); // Verifica el valor en la consola

                    // Mostrar el label con el ID del producto
                    const productIdLabel = document.getElementById('product-id-label');
                    if (productIdLabel) {
                        productIdLabel.textContent = `${id}`;
                        productIdLabel.style.display = 'inline'; // Muestra el label
                    }

                    // Desplazarse hacia el inicio de la página
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        }


        // Función para manejar la edición de un producto
        function handleEditClick(id) {
            const productIdLabel = document.getElementById('product-id-label');
            if (productIdLabel) {
                productIdLabel.textContent = `ID del Producto: ${id}`;
                productIdLabel.style.display = 'inline'; // Muestra el label
            }

            // Puedes también actualizar un campo oculto con el id
            const productIdInput = document.getElementById('product-id');
            if (productIdInput) {
                productIdInput.value = id;
            }
        }

        async function handleAddProduct() {
            const productForm = document.getElementById('product-form'); // Asegúrate de que el ID del formulario coincida

            // Obtén el ID del producto del label
            const productId = document.getElementById('product-id-label').textContent;

            // Recoge los datos del formulario
            const formData = new FormData(productForm);

            // Añade el ID del producto al FormData
            formData.append('product-id', productId);

            // Añade el tipo MOD al FormData
            formData.append('type', 'MOD');

            // Añade el campo ind_principal (es decir, si el producto debe mostrarse en la página principal)
            formData.append('ind_principal', document.getElementById('show-on-homepage').checked ? '1' : '0');

            // Añade un valor por defecto para p_grupo si es necesario (puedes cambiar esto según tus requisitos)
            formData.append('grupo', 'default'); // Cambia 'default' según lo necesario

            // Imprimir los datos de FormData en la consola
            console.log('Datos enviados al procedimiento:');
            formData.forEach((value, key) => {
                console.log(`${key}: ${value}`);
            });

            try {
                const response = await fetch('../php/mod_articulos.php', { // Cambia la ruta al script PHP correcto
                    method: 'POST',
                    body: formData
                });

                // Verifica el código de estado de la respuesta
                if (!response.ok) {
                    throw new Error('Error en la solicitud: ' + response.statusText);
                }

                const result = await response.json();

                // Imprime la respuesta del servidor en la consola
                console.log('Respuesta del servidor:', result);

                // Maneja la respuesta
                if (result.status === 'success') {
                    alert(`Producto guardado exitosamente: ${result.message}`);

                    // Llama a displayResults para mostrar la información actualizada
                    displayResults(result.data);
                } else {
                    alert(`Error al guardar el producto: ${result.message}`);
                }
            } catch (error) {
                console.error('Error al enviar los datos:', error);
            }
        }

        // // Función para enviar el formulario y buscar el producto
        // async function handleAddProduct() {
        //     const productForm = document.getElementById('product-form'); // Asegúrate de que el ID del formulario coincida

        //     // Recoge los datos del formulario
        //     const formData = new FormData(productForm);

        //     // Añade el tipo MOD al FormData
        //     formData.append('type', 'MOD');

        //     // Imprimir los datos de FormData en la consola
        //     console.log('Datos enviados al procedimiento:');
        //     formData.forEach((value, key) => {
        //         console.log(`${key}: ${value}`);
        //     });

        //     try {
        //         const response = await fetch('../php/mod_articulos.php', { // Cambia la ruta al script PHP correcto
        //             method: 'POST',
        //             body: formData
        //         });

        //         const result = await response.json();

        //         // Maneja la respuesta
        //         if (result.status === 'success') {
        //             alert(`Producto guardado exitosamente: ${result.message}`);

        //             // Llama a displayResults para mostrar la información actualizada
        //             displayResults(result.data);
        //         } else {
        //             alert(`Error al guardar el producto: ${result.message}`);
        //         }
        //     } catch (error) {
        //         console.error('Error al enviar los datos:', error);
        //     }
        // }

        // Espera a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            const addProductButton = document.getElementById('add-product-button'); // Asegúrate de que el ID del botón coincida

            // Asocia el evento click al botón de agregar producto
            addProductButton.addEventListener('click', handleAddProduct);
        });




        function loadProductData(id, idSubartic) {
            console.log('Loading product data for id:', id, 'and idSubartic:', idSubartic);

            fetch(`../php/get_product.php?id=${id}&idsubartic=${idSubartic}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched data:', data);
                    if (data) {
                        // Llena los campos del formulario con los datos del producto
                        document.getElementById('product-name').value = data.articulo;
                        document.getElementById('product-id').value = data.idarticulo;
                        document.getElementById('product-code').value = data.codarticulo;
                        document.getElementById('product-description').value = data.descripcion;
                        document.getElementById('product-price').value = data.precio;

                        // Verifica el valor de `ind_principal` y ajusta la visibilidad del grupo de opciones
                        const groupBox = document.getElementById('group-box');
                        if (data.ind_principal === 'S') {
                            groupBox.style.display = 'block';
                            document.getElementById('show-on-homepage').checked = true;
                        } else {
                            groupBox.style.display = 'none';
                            document.getElementById('show-on-homepage').checked = false;
                        }

                        // Ajusta el valor del select basado en `data.grupo_principal`
                        const inicioOptions = document.getElementById('inicioOptions');
                        const grupoPrincipalValue = data.grupo_principal.toString(); // Convertir a cadena si es necesario
                        let optionFound = false;

                        for (let i = 0; i < inicioOptions.options.length; i++) {
                            if (inicioOptions.options[i].value === grupoPrincipalValue) {
                                inicioOptions.selectedIndex = i;
                                optionFound = true;
                                break;
                            }
                        }

                        if (!optionFound) {
                            console.log('No matching option found for grupo_principal value.');
                        }

                    } else {
                        console.log('No data found for the selected product.');
                        alert('No se encontraron datos para el producto seleccionado.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching product data:', error);
                    alert('Error al recuperar los datos del producto.');
                });
        }


        function updatePagination(totalrows, firstrow, lastrow) {
            document.getElementById('totalrows').textContent = totalrows;
            document.getElementById('firstrow').textContent = firstrow;
            document.getElementById('lastrow').textContent = lastrow;
            document.getElementById('page-info').dataset.pageIndex = Math.ceil(firstrow / 10);
        }

        document.getElementById('next-page').addEventListener('click', function () {
            const pageIndex = parseInt(document.getElementById('page-info').dataset.pageIndex);
            fetchArticles(document.getElementById('article-search').value, document.getElementById('status-filter').value, pageIndex + 1);
        });

        document.getElementById('article-search').addEventListener('input', function () {
            fetchArticles(this.value, document.getElementById('status-filter').value, 1);
        });

        document.getElementById('status-filter').addEventListener('change', function () {
            fetchArticles(document.getElementById('article-search').value, this.value, 1);
        });
    </script>

    <footer class="text-center py-4">
        <p>&copy; 2024 azumy Fantasia</p>
        <div class="social-icons">
            <a href="https://www.instagram.com/azumyfantasia" target="_blank">
                <img src="https://img.icons8.com/ios-filled/50/000000/instagram-new.png" alt="Instagram">
            </a>
            <a href="https://www.facebook.com/share/xdnLnDHCXizQeDwT/?mibextid=qi2Omg" target="_blank">
                <img src="https://img.icons8.com/ios-filled/50/000000/facebook-new.png" alt="Facebook">
            </a>
            <a href="https://wa.me/tu_numero" target="_blank">
                <img src="https://img.icons8.com/ios-filled/50/000000/whatsapp.png" alt="WhatsApp">
            </a>
            <a href="https://www.tiktok.com/@azumyfantasia?_t=8on0ihPhIer&_r=1" target="_blank">
                <img src="https://img.icons8.com/ios-filled/50/000000/tiktok.png" alt="TikTok">
            </a>
        </div>
    </footer>
</body>

</html>